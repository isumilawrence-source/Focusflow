<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è‡ªåª’ä½“ä¸“æ³¨ç›®æ ‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            15%, 85% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* ä¼˜åŒ–ç§»åŠ¨ç«¯æ»‘åŠ¨ä½“éªŒ */
        .stage-scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        .stage-scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .stage-scroll-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .stage-scroll-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 3px;
        }
        
        .stage-scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: #a0aec0;
        }
        
        /* å‘¼å¸ç¯åŠ¨ç”» */
        @keyframes breathe {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
            }
            50% {
                opacity: 0.8;
                text-shadow: 0 0 30px rgba(74, 222, 128, 0.8);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-6 py-12">
        <!-- åˆå§‹è®¾å®šç•Œé¢ -->
        <div id="setupView" class="hidden">
            <h1 class="text-5xl font-bold text-gray-900 mb-8 tracking-tight">è®¾ç½®ä½ çš„ä¸“æ³¨ç›®æ ‡</h1>
            
            <!-- ç›®æ ‡è¾“å…¥ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">ä½ çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                <input 
                    type="text" 
                    id="goalInput" 
                    placeholder="ä¾‹å¦‚ï¼šåšå¥½ç»˜ç”»è‡ªåª’ä½“"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-lg"
                >
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-4">æ·»åŠ ä»»åŠ¡</label>
                <div id="taskInputs" class="space-y-3">
                    <!-- ä»»åŠ¡è¾“å…¥æ¡†ä¼šåŠ¨æ€æ·»åŠ  -->
                </div>
                <button 
                    id="addTaskBtn" 
                    class="mt-4 px-4 py-2 text-blue-600 hover:text-blue-700 font-medium text-sm"
                >
                    + æ·»åŠ ä»»åŠ¡
                </button>
            </div>

            <!-- ä¿å­˜æŒ‰é’® -->
            <button 
                id="saveSetupBtn" 
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors"
            >
                å¼€å§‹ä¸“æ³¨
            </button>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div id="mainView" class="hidden">
            <!-- æ ‡é¢˜å’Œæ·»åŠ ä»»åŠ¡æŒ‰é’® -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3 flex-1 group">
                    <h1 
                        id="goalTitle" 
                        class="text-5xl font-bold text-gray-900 tracking-tight cursor-pointer hover:bg-gray-100 rounded-lg px-2 py-1 -mx-2 -my-1 transition-colors border-2 border-transparent hover:border-gray-200"
                        onclick="editGoal()"
                    ></h1>
                    <button
                        onclick="editGoal()"
                        class="text-gray-400 hover:text-blue-600 transition-colors opacity-0 group-hover:opacity-100"
                        title="ç¼–è¾‘ç›®æ ‡"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                </div>
                <button 
                    id="addNewTaskBtn" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-sm"
                >
                    + æ·»åŠ ä»»åŠ¡
                </button>
            </div>
            <p class="text-gray-500 mb-4">é€‰æ‹©ä»Šå¤©è¦åšçš„ä»»åŠ¡ï¼Œè¿½è¸ªä½ çš„è¿›åº¦</p>

            <!-- å¼€å¯ä¸“æ³¨æ¨¡å¼æŒ‰é’® -->
            <div class="mb-6">
                <button 
                    id="startFocusModeBtn" 
                    class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
                >
                    ğŸ¯ å¼€å¯ä»Šæ—¥ä¸“æ³¨æ¨¡å¼
                </button>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div id="taskList" class="space-y-4">
                <!-- ä»»åŠ¡å¡ç‰‡ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ä¸“æ³¨æ¨¡å¼è§†å›¾ -->
        <div id="focusView" class="hidden fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white z-50 overflow-y-auto transition-opacity duration-500">
            <div class="min-h-screen flex flex-col">
                <!-- é¡¶éƒ¨ï¼šå€’è®¡æ—¶å™¨å’Œé€€å‡ºæŒ‰é’® -->
                <div class="flex items-center justify-between p-6">
                    <button 
                        id="exitFocusModeBtn"
                        class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all duration-300 text-white font-medium"
                    >
                        â† é€€å‡ºä¸“æ³¨æ¨¡å¼
                    </button>
                    <div class="flex-1"></div>
                </div>

                <!-- ç•ªèŒ„é’Ÿå€’è®¡æ—¶å™¨ -->
                <div class="text-center py-8">
                    <div class="mb-6">
                        <div class="text-8xl font-bold mb-4 font-mono" id="pomodoroTimer" style="color: #4ade80; text-shadow: 0 0 20px rgba(74, 222, 128, 0.5); animation: breathe 3s ease-in-out infinite;">25:00</div>
                        <div class="flex items-center justify-center gap-3">
                            <button 
                                id="decreaseTimeBtn"
                                class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg font-semibold transition-all duration-300 text-white"
                                title="å‡å°‘5åˆ†é’Ÿ"
                            >
                                -5min
                            </button>
                            <button 
                                id="increaseTimeBtn"
                                class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg font-semibold transition-all duration-300 text-white"
                                title="å¢åŠ 5åˆ†é’Ÿ"
                            >
                                +5min
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-center gap-4">
                        <button 
                            id="startPomodoroBtn"
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-300 shadow-lg"
                        >
                            å¼€å§‹
                        </button>
                        <button 
                            id="pausePomodoroBtn"
                            class="px-8 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition-all duration-300 shadow-lg hidden"
                        >
                            æš‚åœ
                        </button>
                        <button 
                            id="resetPomodoroBtn"
                            class="px-8 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition-all duration-300 shadow-lg"
                        >
                            é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- ä»Šæ—¥ä»»åŠ¡åˆ—è¡¨ -->
                <div class="flex-1 px-6 pb-6">
                    <div id="focusTaskList" class="max-w-4xl mx-auto space-y-6">
                        <!-- ä»Šæ—¥ä»»åŠ¡ä¼šåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åº•éƒ¨æç¤ºè¯­ -->
                <div class="text-center py-8 px-6">
                    <p class="text-gray-400 text-lg italic">åˆ·æ‰‹æœºåªä¼šæ›´ç´¯ï¼Œç”»ç”»/å¬è¯¾æ‰æ˜¯çœŸæ­£çš„æ”¾æ¾ã€‚</p>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘ä»»åŠ¡å¯¹è¯æ¡† -->
        <div id="editTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ç¼–è¾‘ä»»åŠ¡</h2>
                
                <!-- ä»»åŠ¡åç§° -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»»åŠ¡åç§°</label>
                    <input 
                        type="text" 
                        id="editTaskName" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    >
                </div>

                <!-- æ•°å­—ç»Ÿè®¡ç±»çš„è¾“å…¥æ¡† -->
                <div id="editNumericInputsContainer" class="hidden mb-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ€»æ•°é‡</label>
                            <input 
                                type="number" 
                                id="editTotal" 
                                min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰å·²å®Œæˆæ•°é‡</label>
                            <input 
                                type="number" 
                                id="editCurrent" 
                                min="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                            >
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢„ä¼°æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
                        <input 
                            type="number" 
                            id="editEstimatedTime" 
                            min="0"
                            placeholder="ä¾‹å¦‚ï¼š25"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        >
                    </div>
                </div>

                <!-- é˜¶æ®µæµç¨‹ç±»çš„æ­¥éª¤è¾“å…¥ -->
                <div id="editStageStepsContainer" class="hidden mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ­¥éª¤ï¼ˆç”¨é€—å·æˆ–æ¢è¡Œç¬¦åˆ†éš”ï¼Œä¾‹å¦‚ï¼šæ„æ€,çº¿ç¨¿,ä¸Šè‰²,ç»†åŒ–ï¼‰</label>
                    <textarea 
                        id="editStageStepsInput" 
                        rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none"
                    ></textarea>
                    
                    <!-- å®æ—¶é¢„è§ˆåŒº -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-600 mb-2">é¢„è§ˆæ•ˆæœï¼š</label>
                        <div id="editStagePreview" class="overflow-x-auto stage-scroll-container">
                            <div class="flex items-start pb-2" style="min-width: max-content;">
                                <!-- é¢„è§ˆå†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢„ä¼°æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
                        <input 
                            type="number" 
                            id="editStageEstimatedTime" 
                            min="0"
                            placeholder="ä¾‹å¦‚ï¼š25"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        >
                    </div>
                </div>

                <!-- æŒ‰é’® -->
                <div class="flex gap-3">
                    <button 
                        id="cancelEditTaskBtn"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                    <button 
                        id="confirmEditTaskBtn"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ ä»»åŠ¡å¯¹è¯æ¡† -->
        <div id="addTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">æ·»åŠ æ–°ä»»åŠ¡</h2>
                
                <!-- ä»»åŠ¡åç§° -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»»åŠ¡åç§°</label>
                    <input 
                        type="text" 
                        id="modalTaskName" 
                        placeholder="ä¾‹å¦‚ï¼šå¬è¯¾"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    >
                </div>

                <!-- ä»»åŠ¡ç±»å‹é€‰æ‹© -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">ä»»åŠ¡ç±»å‹</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="taskType" value="numeric" class="mr-3" checked>
                            <div>
                                <div class="font-medium text-gray-900">æ•°å­—ç»Ÿè®¡ç±»</div>
                                <div class="text-sm text-gray-500">ä¾‹å¦‚ï¼šå¬è¯¾ã€é˜…è¯»ï¼ˆç”¨æ•°å­—è¿½è¸ªè¿›åº¦ï¼‰</div>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="taskType" value="stage" class="mr-3">
                            <div>
                                <div class="font-medium text-gray-900">é˜¶æ®µæµç¨‹ç±»</div>
                                <div class="text-sm text-gray-500">ä¾‹å¦‚ï¼šç”»ç”»ã€å†™ä½œï¼ˆç”¨æ­¥éª¤è¿½è¸ªè¿›åº¦ï¼‰</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- æ•°å­—ç»Ÿè®¡ç±»çš„è¾“å…¥æ¡† -->
                <div id="numericInputsContainer" class="mb-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ€»è¯¾æ•°</label>
                            <input 
                                type="number" 
                                id="modalTotal" 
                                value="20"
                                min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰å·²ä¸Šåˆ°ç¬¬å‡ è¯¾</label>
                            <input 
                                type="number" 
                                id="modalCurrent" 
                                value="0"
                                min="0"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                            >
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢„ä¼°æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
                        <input 
                            type="number" 
                            id="modalEstimatedTime" 
                            min="0"
                            placeholder="ä¾‹å¦‚ï¼š25"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        >
                    </div>
                </div>

                <!-- é˜¶æ®µæµç¨‹ç±»çš„æ­¥éª¤è¾“å…¥ -->
                <div id="stageStepsContainer" class="hidden mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ­¥éª¤ï¼ˆç”¨é€—å·æˆ–æ¢è¡Œç¬¦åˆ†éš”ï¼Œä¾‹å¦‚ï¼šæ„æ€,çº¿ç¨¿,ä¸Šè‰²,ç»†åŒ–ï¼‰</label>
                    <textarea 
                        id="stageStepsInput" 
                        placeholder="æ„æ€,çº¿ç¨¿,ä¸Šè‰²,ç»†åŒ–"
                        rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none"
                    ></textarea>
                    
                    <!-- å®æ—¶é¢„è§ˆåŒº -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-600 mb-2">é¢„è§ˆæ•ˆæœï¼š</label>
                        <div id="stageStepsPreview" class="overflow-x-auto stage-scroll-container">
                            <div class="flex items-start pb-2" style="min-width: max-content;">
                                <p class="text-gray-400 text-sm text-center py-4">è¾“å…¥æ­¥éª¤åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¢„ä¼°æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
                        <input 
                            type="number" 
                            id="modalStageEstimatedTime" 
                            min="0"
                            placeholder="ä¾‹å¦‚ï¼š25"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        >
                    </div>
                </div>

                <!-- æŒ‰é’® -->
                <div class="flex gap-3">
                    <button 
                        id="cancelAddTaskBtn"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                    <button 
                        id="confirmAddTaskBtn"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®ç®¡ç†
        const Storage = {
            getGoal: () => localStorage.getItem('focusGoal'),
            setGoal: (goal) => localStorage.setItem('focusGoal', goal),
            getTasks: () => {
                const tasks = localStorage.getItem('focusTasks');
                return tasks ? JSON.parse(tasks) : [];
            },
            setTasks: (tasks) => localStorage.setItem('focusTasks', JSON.stringify(tasks)),
            getLastDate: () => localStorage.getItem('lastDate'),
            setLastDate: (date) => localStorage.setItem('lastDate', date),
        };

        // æ£€æŸ¥æ˜¯å¦æ¢å¤©ï¼Œå¦‚æœæ˜¯åˆ™é‡ç½®ä»Šå¤©çš„é€‰æ‹©
        function checkDailyReset() {
            const today = new Date().toDateString();
            const lastDate = Storage.getLastDate();
            
            if (lastDate !== today) {
                const tasks = Storage.getTasks();
                tasks.forEach(task => task.today = false);
                Storage.setTasks(tasks);
                Storage.setLastDate(today);
            }
        }

        // åˆå§‹åŒ–
        function init() {
            checkDailyReset();
            
            const goal = Storage.getGoal();
            if (!goal) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºè®¾ç½®ç•Œé¢
                showSetupView();
            } else {
                // å·²è®¾ç½®ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
                showMainView();
            }
        }

        // æ˜¾ç¤ºè®¾ç½®ç•Œé¢
        function showSetupView() {
            document.getElementById('setupView').classList.remove('hidden');
            document.getElementById('mainView').classList.add('hidden');
            
            // æ·»åŠ åˆå§‹ä»»åŠ¡è¾“å…¥æ¡†
            addTaskInput();
            
            // æ·»åŠ ä»»åŠ¡æŒ‰é’®
            document.getElementById('addTaskBtn').onclick = addTaskInput;
            
            // ä¿å­˜è®¾ç½®
            document.getElementById('saveSetupBtn').onclick = saveSetup;
        }

        // æ·»åŠ ä»»åŠ¡è¾“å…¥æ¡†
        function addTaskInput() {
            const container = document.getElementById('taskInputs');
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input 
                    type="text" 
                    placeholder="ä»»åŠ¡åç§°ï¼ˆå¦‚ï¼šå¬è¯¾ï¼‰"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                >
                <button 
                    class="px-3 py-2 text-red-500 hover:text-red-700 font-medium"
                    onclick="this.parentElement.remove()"
                >
                    åˆ é™¤
                </button>
            `;
            container.appendChild(div);
        }

        // ä¿å­˜è®¾ç½®
        function saveSetup() {
            const goal = document.getElementById('goalInput').value.trim();
            if (!goal) {
                alert('è¯·è¾“å…¥ä½ çš„ç›®æ ‡');
                return;
            }

            const taskInputs = document.querySelectorAll('#taskInputs input');
            const tasks = [];
            taskInputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    // é»˜è®¤åˆ›å»ºæ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡
                    tasks.push({
                        type: 'numeric',
                        name: name,
                        current: 0,
                        total: 1,
                        today: false
                    });
                }
            });

            if (tasks.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡');
                return;
            }

            Storage.setGoal(goal);
            Storage.setTasks(tasks);
            Storage.setLastDate(new Date().toDateString());
            
            showMainView();
        }

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMainView() {
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('focusView').classList.add('hidden');
            
            const goal = Storage.getGoal();
            const titleElement = document.getElementById('goalTitle');
            if (titleElement) {
                titleElement.textContent = goal;
                // ç¡®ä¿ç‚¹å‡»äº‹ä»¶ç»‘å®š
                titleElement.onclick = editGoal;
            }
            
            renderTasks();
            
            // æ·»åŠ æ–°ä»»åŠ¡æŒ‰é’®
            document.getElementById('addNewTaskBtn').onclick = showAddTaskModal;
            
            // å¼€å¯ä¸“æ³¨æ¨¡å¼æŒ‰é’®
            document.getElementById('startFocusModeBtn').onclick = startFocusMode;
        }

        // ç•ªèŒ„é’Ÿç›¸å…³å˜é‡
        let pomodoroInterval = null;
        let pomodoroTime = 25 * 60; // 25åˆ†é’Ÿï¼Œå•ä½ï¼šç§’
        let pomodoroRunning = false;
        let focusStartTime = null; // è®°å½•ä¸“æ³¨å¼€å§‹æ—¶é—´
        let lastTaskUpdateTime = null; // è®°å½•ä¸Šæ¬¡ä»»åŠ¡æ›´æ–°æ—¶é—´

        // å¼€å¯ä¸“æ³¨æ¨¡å¼
        function startFocusMode() {
            const tasks = Storage.getTasks();
            const todayTasks = tasks.filter(task => task.today === true);
            
            if (todayTasks.length === 0) {
                alert('è¯·å…ˆåœ¨åˆ—è¡¨ä¸­å‹¾é€‰ä»Šå¤©è¦å®Œæˆçš„ä»»åŠ¡å“¦');
                return;
            }
            
            // éšè—ä¸»ç•Œé¢ï¼Œæ˜¾ç¤ºä¸“æ³¨æ¨¡å¼
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('focusView').classList.remove('hidden');
            
            // æ¸²æŸ“ä¸“æ³¨æ¨¡å¼ä¸‹çš„ä»»åŠ¡
            renderFocusTasks();
            
            // ç»‘å®šé€€å‡ºæŒ‰é’®
            document.getElementById('exitFocusModeBtn').onclick = exitFocusMode;
            
            // ç»‘å®šç•ªèŒ„é’ŸæŒ‰é’®
            document.getElementById('startPomodoroBtn').onclick = startPomodoro;
            document.getElementById('pausePomodoroBtn').onclick = pausePomodoro;
            document.getElementById('resetPomodoroBtn').onclick = resetPomodoro;
            document.getElementById('increaseTimeBtn').onclick = increasePomodoroTime;
            document.getElementById('decreaseTimeBtn').onclick = decreasePomodoroTime;
            
            // é‡ç½®ç•ªèŒ„é’Ÿ
            resetPomodoro();
        }

        // é€€å‡ºä¸“æ³¨æ¨¡å¼
        function exitFocusMode() {
            // åœæ­¢ç•ªèŒ„é’Ÿ
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                pomodoroRunning = false;
            }
            
            // éšè—ä¸“æ³¨æ¨¡å¼ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
            document.getElementById('focusView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            
            // é‡æ–°æ¸²æŸ“ä¸»ç•Œé¢ä»»åŠ¡
            renderTasks();
        }

        // æ¸²æŸ“ä¸“æ³¨æ¨¡å¼ä¸‹çš„ä»»åŠ¡
        function renderFocusTasks() {
            const tasks = Storage.getTasks();
            const todayTasks = tasks.filter(task => task.today === true);
            const container = document.getElementById('focusTaskList');
            container.innerHTML = '';

            if (todayTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">è¿˜æ²¡æœ‰é€‰æ‹©ä»Šå¤©çš„ä»»åŠ¡</p>';
                return;
            }

            const colorMap = {
                0: 'bg-blue-500',
                1: 'bg-purple-500',
                2: 'bg-green-500',
                3: 'bg-orange-500',
                4: 'bg-pink-500',
                5: 'bg-indigo-500'
            };
            
            todayTasks.forEach((task, index) => {
                const colorClass = colorMap[index % 6];
                const taskType = task.type || 'numeric';
                
                let cardHTML = '';
                
                if (taskType === 'numeric') {
                    // æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡
                    const total = task.total || 1;
                    const current = task.current || 0;
                    
                    // ç”Ÿæˆæ‰€æœ‰åœ†åœˆ
                    const circles = [];
                    for (let i = 0; i < total; i++) {
                        const isCompleted = i < current;
                        const isNext = i === current;
                        circles.push(`
                            <button
                                onclick="clickCircleInFocus(${tasks.indexOf(task)}, ${i})"
                                class="w-8 h-8 rounded-full border-2 transition-all duration-200 ${
                                    isCompleted 
                                        ? 'bg-green-500 border-green-500 hover:bg-green-600 cursor-pointer' 
                                        : isNext
                                        ? 'bg-white border-gray-400 hover:border-green-500 hover:bg-green-50 cursor-pointer text-gray-800'
                                        : 'bg-white border-gray-300 cursor-not-allowed opacity-50 text-gray-800'
                                }"
                                title="ç¬¬ ${i + 1} è¯¾"
                                ${!isCompleted && !isNext ? 'disabled' : ''}
                            ></button>
                        `);
                    }
                    
                    cardHTML = `
                        <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-white border-opacity-20">
                            <div class="mb-4">
                                <h2 class="text-2xl font-semibold text-white mb-2">${task.name}</h2>
                                <span class="text-gray-300">${current}/${total}</span>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${circles.join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // é˜¶æ®µæµç¨‹ç±»ä»»åŠ¡
                    const steps = task.steps || [];
                    const completedSteps = steps.filter(s => s.completed).length;
                    const totalSteps = steps.length;
                    
                    // ç”Ÿæˆæ¨ªå‘æ­¥éª¤èŠ‚ç‚¹
                    const stepsWithConnectors = steps.map((step, stepIndex) => {
                        const isCompleted = step.completed;
                        const nodeHTML = `
                            <div class="flex flex-col items-center flex-shrink-0" style="min-width: 80px;">
                                <button
                                    onclick="clickStageNodeInFocus(${tasks.indexOf(task)}, ${stepIndex})"
                                    class="w-12 h-12 rounded-full border-2 transition-all duration-300 ${
                                        isCompleted 
                                            ? 'bg-blue-500 border-blue-500 hover:bg-blue-600' 
                                            : 'bg-white border-gray-400 hover:border-blue-400 text-gray-800'
                                    } cursor-pointer mb-2"
                                    title="${step.name}"
                                >
                                    ${isCompleted ? `
                                        <svg class="w-7 h-7 mx-auto text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    ` : ''}
                                </button>
                                <span class="text-sm text-center text-gray-300 max-w-[80px] break-words">${step.name}</span>
                            </div>
                        `;
                        
                        if (stepIndex < steps.length - 1) {
                            const connectorHTML = `
                                <div class="flex-1 h-0.5 mx-2 transition-colors duration-300 ${
                                    isCompleted ? 'bg-blue-500' : 'bg-gray-400'
                                }" style="margin-top: 24px;"></div>
                            `;
                            return nodeHTML + connectorHTML;
                        }
                        return nodeHTML;
                    }).join('');
                    
                    cardHTML = `
                        <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 border border-white border-opacity-20">
                            <div class="mb-4">
                                <h2 class="text-2xl font-semibold text-white mb-2">${task.name}</h2>
                                <span class="text-gray-300">${completedSteps}/${totalSteps}</span>
                            </div>
                            <div class="overflow-x-auto stage-scroll-container">
                                <div class="flex items-start pb-2" style="min-width: max-content;">
                                    ${stepsWithConnectors}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML += cardHTML;
            });
        }

        // æ£€æŸ¥æ˜¯å¦åœ¨ä¸“æ³¨æ¨¡å¼ä¸‹
        function isInFocusMode() {
            const focusView = document.getElementById('focusView');
            return focusView && !focusView.classList.contains('hidden');
        }

        // åœ¨ä¸“æ³¨æ¨¡å¼ä¸‹ç‚¹å‡»åœ†åœˆ
        function clickCircleInFocus(taskIndex, circleIndex) {
            const tasks = Storage.getTasks();
            const task = tasks[taskIndex];
            
            if (task.type !== 'numeric') return;
            
            const current = task.current || 0;
            const total = task.total || 1;
            
            if (circleIndex < current) {
                if (circleIndex === current - 1) {
                    task.current = circleIndex;
                    Storage.setTasks(tasks);
                    renderFocusTasks();
                }
                return;
            }
            
            if (circleIndex === current && circleIndex < total) {
                task.current = current + 1;
                Storage.setTasks(tasks);
                recordFocusTime(taskIndex); // è®°å½•ä¸“æ³¨æ—¶é—´
                showEncouragement();
                renderFocusTasks();
            }
        }

        // åœ¨ä¸“æ³¨æ¨¡å¼ä¸‹ç‚¹å‡»é˜¶æ®µèŠ‚ç‚¹
        function clickStageNodeInFocus(taskIndex, stepIndex) {
            const tasks = Storage.getTasks();
            const task = tasks[taskIndex];
            
            if (task.type === 'stage' && task.steps && task.steps[stepIndex]) {
                const clickedStep = task.steps[stepIndex];
                const wasCompleted = clickedStep.completed;
                
                if (wasCompleted) {
                    for (let i = stepIndex; i < task.steps.length; i++) {
                        task.steps[i].completed = false;
                    }
                } else {
                    for (let i = 0; i <= stepIndex; i++) {
                        task.steps[i].completed = true;
                    }
                    recordFocusTime(taskIndex); // è®°å½•ä¸“æ³¨æ—¶é—´
                    showEncouragement();
                }
                
                Storage.setTasks(tasks);
                renderFocusTasks();
            }
        }

        // å¼€å§‹ç•ªèŒ„é’Ÿ
        // æ’­æ”¾æç¤ºéŸ³
        function playNotificationSound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®éŸ³è°ƒï¼ˆæ¸©å’Œçš„éŸ³è°ƒï¼‰
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                // è®¾ç½®éŸ³é‡ï¼ˆæ¸©å’Œï¼‰
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                // æ’­æ”¾
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                // å¦‚æœéŸ³é¢‘APIä¸å¯ç”¨ï¼Œé™é»˜å¤±è´¥
                console.log('Audio not available');
            }
        }

        // è®°å½•ä¸“æ³¨æ—¶é—´
        function recordFocusTime(taskIndex) {
            if (pomodoroRunning && focusStartTime) {
                const now = Date.now();
                const focusDuration = Math.floor((now - (lastTaskUpdateTime || focusStartTime)) / 1000); // ç§’
                
                if (focusDuration > 0) {
                    // ä¿å­˜ä¸“æ³¨æ—¶é—´åˆ°localStorage
                    const focusRecords = JSON.parse(localStorage.getItem('focusRecords') || '[]');
                    focusRecords.push({
                        taskIndex: taskIndex,
                        duration: focusDuration,
                        timestamp: now
                    });
                    localStorage.setItem('focusRecords', JSON.stringify(focusRecords));
                }
                
                lastTaskUpdateTime = now;
            }
        }

        function startPomodoro() {
            if (pomodoroRunning) return;
            
            pomodoroRunning = true;
            focusStartTime = Date.now();
            lastTaskUpdateTime = focusStartTime;
            
            document.getElementById('startPomodoroBtn').classList.add('hidden');
            document.getElementById('pausePomodoroBtn').classList.remove('hidden');
            
            pomodoroInterval = setInterval(() => {
                pomodoroTime--;
                updatePomodoroDisplay();
                
                if (pomodoroTime <= 0) {
                    pausePomodoro();
                    playNotificationSound();
                    showEncouragement();
                    setTimeout(() => {
                        alert('ğŸ‰ ä¸“æ³¨æ—¶é—´åˆ°ï¼ä¼‘æ¯ä¸€ä¸‹å§ï½');
                    }, 500);
                    resetPomodoro();
                }
            }, 1000);
        }

        // æš‚åœç•ªèŒ„é’Ÿ
        function pausePomodoro() {
            if (!pomodoroRunning) return;
            
            pomodoroRunning = false;
            document.getElementById('startPomodoroBtn').classList.remove('hidden');
            document.getElementById('pausePomodoroBtn').classList.add('hidden');
            
            if (pomodoroInterval) {
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
            }
        }

        // é‡ç½®ç•ªèŒ„é’Ÿ
        function resetPomodoro() {
            pausePomodoro();
            pomodoroTime = 25 * 60;
            focusStartTime = null;
            lastTaskUpdateTime = null;
            updatePomodoroDisplay();
        }

        // å¢åŠ 5åˆ†é’Ÿ
        function increasePomodoroTime() {
            if (pomodoroRunning) return;
            pomodoroTime = Math.min(pomodoroTime + 5 * 60, 120 * 60); // æœ€å¤š120åˆ†é’Ÿ
            updatePomodoroDisplay();
        }

        // å‡å°‘5åˆ†é’Ÿ
        function decreasePomodoroTime() {
            if (pomodoroRunning) return;
            pomodoroTime = Math.max(pomodoroTime - 5 * 60, 5 * 60); // æœ€å°‘5åˆ†é’Ÿ
            updatePomodoroDisplay();
        }

        // æ›´æ–°ç•ªèŒ„é’Ÿæ˜¾ç¤º
        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroTime / 60);
            const seconds = pomodoroTime % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pomodoroTimer').textContent = display;
        }

        // ç¼–è¾‘ç›®æ ‡
        function editGoal() {
            const titleElement = document.getElementById('goalTitle');
            if (!titleElement) return;
            
            // å¦‚æœå·²ç»æ˜¯è¾“å…¥æ¡†ï¼Œä¸é‡å¤åˆ›å»º
            if (titleElement.tagName === 'INPUT') return;
            
            const currentGoal = titleElement.textContent;
            const parentContainer = titleElement.parentElement;
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentGoal;
            input.id = 'goalTitle'; // ä¿æŒç›¸åŒçš„ ID
            input.className = 'text-5xl font-bold text-gray-900 tracking-tight bg-transparent border-b-2 border-blue-500 outline-none w-full px-2 -mx-2';
            input.style.fontSize = 'inherit';
            input.style.fontWeight = 'inherit';
            input.style.letterSpacing = 'inherit';
            
            // ä¿å­˜å‡½æ•°
            const saveGoal = () => {
                const newGoal = input.value.trim();
                
                // æ¢å¤æ ‡é¢˜å…ƒç´ 
                const newTitle = document.createElement('h1');
                newTitle.id = 'goalTitle';
                newTitle.className = 'text-5xl font-bold text-gray-900 tracking-tight cursor-pointer hover:bg-gray-100 rounded-lg px-2 py-1 -mx-2 -my-1 transition-colors border-2 border-transparent hover:border-gray-200';
                newTitle.textContent = newGoal || currentGoal;
                newTitle.onclick = editGoal;
                
                if (newGoal && newGoal !== currentGoal) {
                    Storage.setGoal(newGoal);
                }
                
                input.replaceWith(newTitle);
            };
            
            // æŒ‰å›è½¦ä¿å­˜
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveGoal();
                }
                if (e.key === 'Escape') {
                    const newTitle = document.createElement('h1');
                    newTitle.id = 'goalTitle';
                    newTitle.className = 'text-5xl font-bold text-gray-900 tracking-tight cursor-pointer hover:bg-gray-100 rounded-lg px-2 py-1 -mx-2 -my-1 transition-colors border-2 border-transparent hover:border-gray-200';
                    newTitle.textContent = currentGoal;
                    newTitle.onclick = editGoal;
                    input.replaceWith(newTitle);
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            input.addEventListener('blur', saveGoal);
            
            // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
            titleElement.replaceWith(input);
            
            // è‡ªåŠ¨èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
            setTimeout(() => {
                input.focus();
                input.select();
            }, 0);
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const tasks = Storage.getTasks();
            const container = document.getElementById('taskList');
            container.innerHTML = '';

            if (tasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            const colorMap = {
                0: 'bg-blue-500',
                1: 'bg-purple-500',
                2: 'bg-green-500',
                3: 'bg-orange-500',
                4: 'bg-pink-500',
                5: 'bg-indigo-500'
            };
            
            tasks.forEach((task, index) => {
                const colorClass = colorMap[index % 6];
                const taskType = task.type || 'numeric'; // å…¼å®¹æ—§æ•°æ®
                
                let cardHTML = '';
                
                if (taskType === 'numeric') {
                    // æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡ - ä½¿ç”¨åœ†åœˆæ˜¾ç¤º
                    const total = task.total || 1;
                    const current = task.current || 0;
                    
                    // ç”Ÿæˆæ‰€æœ‰åœ†åœˆï¼ˆä¸æŠ˜å ï¼‰
                    const circles = [];
                    for (let i = 0; i < total; i++) {
                        const isCompleted = i < current;
                        const isNext = i === current; // ä¸‹ä¸€ä¸ªå¯ç‚¹å‡»çš„åœ†åœˆ
                        circles.push(`
                            <button
                                onclick="clickCircle(${index}, ${i})"
                                class="w-7 h-7 rounded-full border-2 transition-all duration-200 ${
                                    isCompleted 
                                        ? 'bg-green-500 border-green-500 hover:bg-green-600 cursor-pointer' 
                                        : isNext
                                        ? 'bg-white border-gray-400 hover:border-green-500 hover:bg-green-50 cursor-pointer'
                                        : 'bg-white border-gray-300 cursor-not-allowed opacity-50'
                                }"
                                title="ç¬¬ ${i + 1} è¯¾${isCompleted ? 'ï¼ˆå·²å®Œæˆï¼‰' : isNext ? 'ï¼ˆç‚¹å‡»å®Œæˆï¼‰' : 'ï¼ˆæŒ‰é¡ºåºå®Œæˆï¼‰'}"
                                ${!isCompleted && !isNext ? 'disabled' : ''}
                            ></button>
                        `);
                    }
                    
                    cardHTML = `
                        <div class="flex items-start gap-4">
                            <!-- ä»Šå¤©è¦åšå¤é€‰æ¡† -->
                            <input 
                                type="checkbox" 
                                ${task.today ? 'checked' : ''}
                                onchange="toggleToday(${index})"
                                class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                            >
                            
                            <div class="flex-1">
                                <!-- ä»»åŠ¡åç§°å’Œè¿›åº¦ -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <h2 class="text-xl font-semibold text-gray-800">${task.name}</h2>
                                        ${task.estimatedTime ? `<span class="text-sm text-gray-500">â±ï¸ ${task.estimatedTime}min</span>` : ''}
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span 
                                            class="text-sm text-gray-500 cursor-pointer hover:text-blue-600 hover:underline transition-colors"
                                            onclick="editTotal(${index})"
                                            title="ç‚¹å‡»ä¿®æ”¹æ€»ç›®æ ‡æ•°"
                                        >${current}/${total}</span>
                                        <button
                                            onclick="showEditTaskModal(${index})"
                                            class="text-gray-400 hover:text-blue-600 transition-colors"
                                            title="ç¼–è¾‘ä»»åŠ¡"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- åœ†åœˆè¿›åº¦æ˜¾ç¤º -->
                                <div class="flex flex-wrap gap-1.5 mb-4">
                                    ${circles.join('')}
                                </div>
                                
                                <!-- æ“ä½œæŒ‰é’® -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <button 
                                        onclick="deleteTask(${index})"
                                        class="px-3 py-1 text-sm text-red-500 hover:text-red-700"
                                    >
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // é˜¶æ®µæµç¨‹ç±»ä»»åŠ¡ - æ¨ªå‘æ­¥éª¤è½´
                    const steps = task.steps || [];
                    const completedSteps = steps.filter(s => s.completed).length;
                    const totalSteps = steps.length;
                    const percentage = totalSteps > 0 ? (completedSteps / totalSteps * 100) : 0;
                    
                    // ç”Ÿæˆæ¨ªå‘æ­¥éª¤èŠ‚ç‚¹
                    const stepsHTML = steps.map((step, stepIndex) => {
                        const isCompleted = step.completed;
                        const isClickable = true; // æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ç‚¹å‡»
                        
                        return `
                            <div class="flex flex-col items-center flex-shrink-0" style="min-width: 80px;">
                                <button
                                    onclick="clickStageNode(${index}, ${stepIndex})"
                                    class="w-10 h-10 rounded-full border-2 transition-all duration-300 ${
                                        isCompleted 
                                            ? 'bg-blue-500 border-blue-500 hover:bg-blue-600' 
                                            : 'bg-white border-gray-300 hover:border-blue-400'
                                    } cursor-pointer mb-2"
                                    title="${step.name}"
                                >
                                    ${isCompleted ? `
                                        <svg class="w-6 h-6 mx-auto text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    ` : ''}
                                </button>
                                <span class="text-xs text-center text-gray-600 max-w-[80px] break-words">${step.name}</span>
                            </div>
                        `;
                    }).join('');
                    
                    // è¿æ¥çº¿ï¼ˆåœ¨èŠ‚ç‚¹ä¹‹é—´ï¼‰
                    const connectorsHTML = steps.length > 1 ? steps.slice(0, -1).map((step, stepIndex) => {
                        const isCompleted = step.completed;
                        return `
                            <div class="flex-1 h-0.5 mx-2 transition-colors duration-300 ${
                                isCompleted ? 'bg-blue-500' : 'bg-gray-200'
                            }" style="margin-top: 20px;"></div>
                        `;
                    }).join('') : '';
                    
                    // ç»„åˆèŠ‚ç‚¹å’Œè¿æ¥çº¿
                    const stepsWithConnectors = steps.map((step, stepIndex) => {
                        const isCompleted = step.completed;
                        const nodeHTML = `
                            <div class="flex flex-col items-center flex-shrink-0" style="min-width: 80px;">
                                <button
                                    onclick="clickStageNode(${index}, ${stepIndex})"
                                    class="w-10 h-10 rounded-full border-2 transition-all duration-300 ${
                                        isCompleted 
                                            ? 'bg-blue-500 border-blue-500 hover:bg-blue-600' 
                                            : 'bg-white border-gray-300 hover:border-blue-400'
                                    } cursor-pointer mb-2"
                                    title="${step.name}"
                                >
                                    ${isCompleted ? `
                                        <svg class="w-6 h-6 mx-auto text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    ` : ''}
                                </button>
                                <span class="text-xs text-center text-gray-600 max-w-[80px] break-words">${step.name}</span>
                            </div>
                        `;
                        
                        // æœ€åä¸€ä¸ªèŠ‚ç‚¹åä¸åŠ è¿æ¥çº¿
                        if (stepIndex < steps.length - 1) {
                            const connectorHTML = `
                                <div class="flex-1 h-0.5 mx-2 transition-colors duration-300 ${
                                    isCompleted ? 'bg-blue-500' : 'bg-gray-200'
                                }" style="margin-top: 20px;"></div>
                            `;
                            return nodeHTML + connectorHTML;
                        }
                        return nodeHTML;
                    }).join('');
                    
                    cardHTML = `
                        <div class="flex items-start gap-4">
                            <!-- ä»Šå¤©è¦åšå¤é€‰æ¡† -->
                            <input 
                                type="checkbox" 
                                ${task.today ? 'checked' : ''}
                                onchange="toggleToday(${index})"
                                class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                            >
                            
                            <div class="flex-1">
                                <!-- ä»»åŠ¡åç§°å’Œè¿›åº¦ -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <h2 class="text-xl font-semibold text-gray-800">${task.name}</h2>
                                        ${task.estimatedTime ? `<span class="text-sm text-gray-500">â±ï¸ ${task.estimatedTime}min</span>` : ''}
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm text-gray-500">${completedSteps}/${totalSteps}</span>
                                        <button
                                            onclick="showEditTaskModal(${index})"
                                            class="text-gray-400 hover:text-blue-600 transition-colors"
                                            title="ç¼–è¾‘ä»»åŠ¡"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- è¿›åº¦æ¡ -->
                                <div class="w-full bg-gray-100 rounded-full h-2.5 mb-4">
                                    <div 
                                        class="${colorClass} h-2.5 rounded-full transition-all duration-300" 
                                        style="width: ${percentage}%"
                                    ></div>
                                </div>
                                
                                <!-- æ¨ªå‘æ­¥éª¤è½´ -->
                                <div class="mb-4 overflow-x-auto stage-scroll-container">
                                    <div class="flex items-start pb-2" style="min-width: max-content;">
                                        ${stepsWithConnectors}
                                    </div>
                                </div>
                                
                                <!-- æ“ä½œæŒ‰é’® -->
                                <div class="flex items-center gap-2">
                                    <button 
                                        onclick="deleteTask(${index})"
                                        class="px-3 py-1 text-sm text-red-500 hover:text-red-700"
                                    >
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow`;
                card.innerHTML = cardHTML;
                container.appendChild(card);
            });
        }

        // åˆ‡æ¢ä»Šå¤©è¦åš
        function toggleToday(index) {
            const tasks = Storage.getTasks();
            tasks[index].today = !tasks[index].today;
            Storage.setTasks(tasks);
            renderTasks();
        }

        // é¼“åŠ±è¯­æ•°ç»„
        const encouragements = [
            'ç¦» YouTube å¤§ä¸»åˆè¿‘äº†ä¸€æ­¥ï¼',
            'å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼',
            'ä½ æ­£åœ¨å˜å¾—æ›´å¥½ï¼',
            'æ¯ä¸€æ­¥éƒ½å¾ˆé‡è¦ï¼',
            'åšæŒå°±æ˜¯èƒœåˆ©ï¼',
            'ä½ åšå¾—å¾ˆå¥½ï¼',
            'ç»§ç»­åŠ æ²¹ï¼',
            'ä½ ç¦»ç›®æ ‡æ›´è¿‘äº†ï¼',
            'äº†ä¸èµ·çš„è¿›æ­¥ï¼',
            'ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼'
        ];

        // æ˜¾ç¤ºé¼“åŠ±è¯­
        function showEncouragement() {
            const message = encouragements[Math.floor(Math.random() * encouragements.length)];
            
            // åˆ›å»ºæç¤ºæ¡†
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-fade-in';
            toast.textContent = message;
            toast.style.animation = 'fadeInOut 2s ease-in-out';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-in-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 1500);
        }

        // æ›´æ–°è¿›åº¦ï¼ˆä»…æ•°å­—ç»Ÿè®¡ç±»ï¼‰
        function updateProgress(index, delta) {
            const tasks = Storage.getTasks();
            const task = tasks[index];
            
            // åªå¯¹æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡æœ‰æ•ˆ
            if (task.type !== 'numeric') return;
            
            const oldCurrent = task.current;
            task.current = Math.max(0, task.current + delta);
            Storage.setTasks(tasks);
            
            // å¦‚æœæ˜¯+1ä¸”è¿›åº¦å¢åŠ äº†ï¼Œæ˜¾ç¤ºé¼“åŠ±è¯­
            if (delta > 0 && task.current > oldCurrent) {
                showEncouragement();
            }
            
            renderTasks();
        }

        // è®¾ç½®è¿›åº¦ï¼ˆä»…æ•°å­—ç»Ÿè®¡ç±»ï¼‰
        function setProgress(index, value) {
            const tasks = Storage.getTasks();
            const task = tasks[index];
            
            // åªå¯¹æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡æœ‰æ•ˆ
            if (task.type !== 'numeric') return;
            
            task.current = Math.max(0, parseInt(value) || 0);
            Storage.setTasks(tasks);
            renderTasks();
        }

        // è®¾ç½®æ€»æ•°ï¼ˆä»…æ•°å­—ç»Ÿè®¡ç±»ï¼‰
        function setTotal(index, value) {
            const tasks = Storage.getTasks();
            const task = tasks[index];
            
            // åªå¯¹æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡æœ‰æ•ˆ
            if (task.type !== 'numeric') return;
            
            task.total = Math.max(1, parseInt(value) || 1);
            Storage.setTasks(tasks);
            renderTasks();
        }

        // ç¼–è¾‘æ€»æ•°ï¼ˆç‚¹å‡»è¿›åº¦æ•°å­—æ—¶ï¼‰
        function editTotal(index) {
            const tasks = Storage.getTasks();
            const task = tasks[index];
            
            // åªå¯¹æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡æœ‰æ•ˆ
            if (task.type !== 'numeric') return;
            
            const currentTotal = task.total;
            const currentProgress = task.current || 0;
            const newTotal = prompt(`ä¿®æ”¹æ€»ç›®æ ‡æ•°ï¼ˆå½“å‰ï¼š${currentTotal}ï¼‰ï¼š`, currentTotal);
            
            if (newTotal !== null && newTotal !== '') {
                const total = parseInt(newTotal);
                if (!isNaN(total) && total > 0) {
                    task.total = total;
                    // å¦‚æœå½“å‰è¿›åº¦è¶…è¿‡æ–°çš„æ€»æ•°ï¼Œè°ƒæ•´ä¸ºæ–°çš„æ€»æ•°
                    if (currentProgress > total) {
                        task.current = total;
                    }
                    Storage.setTasks(tasks);
                    renderTasks();
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                }
            }
        }

        // ç‚¹å‡»åœ†åœˆï¼ˆæ•°å­—ç»Ÿè®¡ç±»ï¼‰
        function clickCircle(taskIndex, circleIndex) {
            const tasks = Storage.getTasks();
            const task = tasks[taskIndex];
            
            // åªå¯¹æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡æœ‰æ•ˆ
            if (task.type !== 'numeric') return;
            
            const current = task.current || 0;
            const total = task.total || 1;
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å·²å®Œæˆçš„åœ†åœˆï¼ˆæœ€åä¸€ä¸ªå·²å®Œæˆçš„ï¼‰ï¼Œå¯ä»¥å–æ¶ˆå®Œæˆ
            if (circleIndex < current) {
                // åªèƒ½å–æ¶ˆæœ€åä¸€ä¸ªå·²å®Œæˆçš„
                if (circleIndex === current - 1) {
                    task.current = circleIndex;
                    Storage.setTasks(tasks);
                    if (!isInFocusMode()) {
                        renderTasks();
                    }
                }
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„åœ†åœˆï¼ˆæŒ‰é¡ºåºå®Œæˆï¼‰
            if (circleIndex === current && circleIndex < total) {
                task.current = current + 1;
                Storage.setTasks(tasks);
                
                // æ˜¾ç¤ºé¼“åŠ±è¯­
                showEncouragement();
                
                if (!isInFocusMode()) {
                    renderTasks();
                }
            }
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ›´åé¢çš„åœ†åœˆï¼Œä¸åšä»»ä½•æ“ä½œï¼ˆå·²é€šè¿‡ disabled å±æ€§ç¦ç”¨ï¼‰
        }

        // åˆ‡æ¢æ­¥éª¤å®ŒæˆçŠ¶æ€ï¼ˆé˜¶æ®µæµç¨‹ç±»ï¼‰- æ—§ç‰ˆæœ¬ï¼Œä¿ç•™å…¼å®¹
        function toggleStep(taskIndex, stepIndex) {
            const tasks = Storage.getTasks();
            const task = tasks[taskIndex];
            
            if (task.type === 'stage' && task.steps && task.steps[stepIndex]) {
                const step = task.steps[stepIndex];
                step.completed = !step.completed;
                
                // å¦‚æœå®Œæˆæ­¥éª¤ï¼Œæ˜¾ç¤ºé¼“åŠ±è¯­
                if (step.completed) {
                    showEncouragement();
                }
                
                Storage.setTasks(tasks);
                renderTasks();
            }
        }

        // ç‚¹å‡»é˜¶æ®µèŠ‚ç‚¹ï¼ˆé˜¶æ®µæµç¨‹ç±»ï¼‰- æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»èŠ‚ç‚¹æ—¶è¯¥èŠ‚ç‚¹åŠä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å®Œæˆ
        function clickStageNode(taskIndex, stepIndex) {
            const tasks = Storage.getTasks();
            const task = tasks[taskIndex];
            
            if (task.type === 'stage' && task.steps && task.steps[stepIndex]) {
                const clickedStep = task.steps[stepIndex];
                const wasCompleted = clickedStep.completed;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å·²å®Œæˆçš„èŠ‚ç‚¹ï¼Œå–æ¶ˆè¯¥èŠ‚ç‚¹åŠä¹‹åçš„æ‰€æœ‰èŠ‚ç‚¹
                if (wasCompleted) {
                    for (let i = stepIndex; i < task.steps.length; i++) {
                        task.steps[i].completed = false;
                    }
                } else {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æœªå®Œæˆçš„èŠ‚ç‚¹ï¼Œå®Œæˆè¯¥èŠ‚ç‚¹åŠä¹‹å‰çš„æ‰€æœ‰èŠ‚ç‚¹
                    for (let i = 0; i <= stepIndex; i++) {
                        task.steps[i].completed = true;
                    }
                    // æ˜¾ç¤ºé¼“åŠ±è¯­
                    showEncouragement();
                }
                
                Storage.setTasks(tasks);
                if (!isInFocusMode()) {
                    renderTasks();
                }
            }
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                const tasks = Storage.getTasks();
                tasks.splice(index, 1);
                Storage.setTasks(tasks);
                renderTasks();
            }
        }

        // æ›´æ–°é˜¶æ®µé¢„è§ˆï¼ˆç¼–è¾‘å¼¹çª—ï¼‰
        function updateStagePreview(stepsText) {
            const previewContainer = document.getElementById('editStagePreview');
            if (!previewContainer) return;
            
            // è§£ææ­¥éª¤
            const stepNames = stepsText.split(/[,\n]/).filter(s => s.trim()).map(s => s.trim());
            
            if (stepNames.length === 0) {
                previewContainer.querySelector('div').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">è¾“å…¥æ­¥éª¤åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</p>';
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆèŠ‚ç‚¹
            const previewHTML = stepNames.map((stepName, stepIndex) => {
                const nodeHTML = `
                    <div class="flex flex-col items-center flex-shrink-0" style="min-width: 80px;">
                        <div class="w-10 h-10 rounded-full border-2 bg-white border-gray-300 mb-2 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <span class="text-xs text-center text-gray-600 max-w-[80px] break-words">${stepName}</span>
                    </div>
                `;
                
                // æœ€åä¸€ä¸ªèŠ‚ç‚¹åä¸åŠ è¿æ¥çº¿
                if (stepIndex < stepNames.length - 1) {
                    const connectorHTML = `
                        <div class="flex-1 h-0.5 mx-2 bg-gray-200" style="margin-top: 20px;"></div>
                    `;
                    return nodeHTML + connectorHTML;
                }
                return nodeHTML;
            }).join('');
            
            previewContainer.querySelector('div').innerHTML = previewHTML;
        }

        // æ›´æ–°é˜¶æ®µé¢„è§ˆï¼ˆæ·»åŠ ä»»åŠ¡å¼¹çª—ï¼‰
        function updateStagePreviewForAdd(stepsText) {
            const previewContainer = document.getElementById('stageStepsPreview');
            if (!previewContainer) return;
            
            // è§£ææ­¥éª¤
            const stepNames = stepsText.split(/[,\n]/).filter(s => s.trim()).map(s => s.trim());
            
            if (stepNames.length === 0) {
                previewContainer.querySelector('div').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">è¾“å…¥æ­¥éª¤åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</p>';
                return;
            }
            
            // ç”Ÿæˆé¢„è§ˆèŠ‚ç‚¹
            const previewHTML = stepNames.map((stepName, stepIndex) => {
                const nodeHTML = `
                    <div class="flex flex-col items-center flex-shrink-0" style="min-width: 80px;">
                        <div class="w-10 h-10 rounded-full border-2 bg-white border-gray-300 mb-2 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <span class="text-xs text-center text-gray-600 max-w-[80px] break-words">${stepName}</span>
                    </div>
                `;
                
                // æœ€åä¸€ä¸ªèŠ‚ç‚¹åä¸åŠ è¿æ¥çº¿
                if (stepIndex < stepNames.length - 1) {
                    const connectorHTML = `
                        <div class="flex-1 h-0.5 mx-2 bg-gray-200" style="margin-top: 20px;"></div>
                    `;
                    return nodeHTML + connectorHTML;
                }
                return nodeHTML;
            }).join('');
            
            previewContainer.querySelector('div').innerHTML = previewHTML;
        }

        // æ˜¾ç¤ºç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡†
        function showEditTaskModal(index) {
            const tasks = Storage.getTasks();
            const task = tasks[index];
            
            if (!task) return;
            
            const modal = document.getElementById('editTaskModal');
            modal.classList.remove('hidden');
            
            // ä¿å­˜å½“å‰ç¼–è¾‘çš„ä»»åŠ¡ç´¢å¼•
            modal.dataset.taskIndex = index;
            
            // å¡«å……ä»»åŠ¡åç§°
            document.getElementById('editTaskName').value = task.name || '';
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºç›¸åº”çš„è¾“å…¥æ¡†
            if (task.type === 'numeric') {
                // æ•°å­—ç»Ÿè®¡ç±»
                document.getElementById('editNumericInputsContainer').classList.remove('hidden');
                document.getElementById('editStageStepsContainer').classList.add('hidden');
                
                document.getElementById('editTotal').value = task.total || 1;
                document.getElementById('editCurrent').value = task.current || 0;
                document.getElementById('editEstimatedTime').value = task.estimatedTime || '';
            } else {
                // é˜¶æ®µæµç¨‹ç±»
                document.getElementById('editNumericInputsContainer').classList.add('hidden');
                document.getElementById('editStageStepsContainer').classList.remove('hidden');
                
                const steps = task.steps || [];
                const stepNames = steps.map(s => s.name).join(',');
                const stepsInput = document.getElementById('editStageStepsInput');
                stepsInput.value = stepNames;
                
                document.getElementById('editStageEstimatedTime').value = task.estimatedTime || '';
                
                // åˆå§‹åŒ–é¢„è§ˆ
                updateStagePreview(stepsInput.value);
                
                // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
                stepsInput.addEventListener('input', function() {
                    updateStagePreview(this.value);
                });
            }
            
            // å…³é—­æ¨¡æ€æ¡†çš„å‡½æ•°
            const closeModal = () => {
                modal.classList.add('hidden');
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            };
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelEditTaskBtn').onclick = closeModal;
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('confirmEditTaskBtn').onclick = () => {
                const taskIndex = parseInt(modal.dataset.taskIndex);
                const tasks = Storage.getTasks();
                const task = tasks[taskIndex];
                
                if (!task) return;
                
                // æ›´æ–°ä»»åŠ¡åç§°
                const newName = document.getElementById('editTaskName').value.trim();
                if (!newName) {
                    alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                    return;
                }
                task.name = newName;
                
                if (task.type === 'numeric') {
                    // æ›´æ–°æ•°å­—ç»Ÿè®¡ç±»ä»»åŠ¡
                    const total = parseInt(document.getElementById('editTotal').value) || 1;
                    const current = parseInt(document.getElementById('editCurrent').value) || 0;
                    const estimatedTime = parseInt(document.getElementById('editEstimatedTime').value) || null;
                    
                    task.total = Math.max(1, total);
                    task.current = Math.max(0, Math.min(current, task.total)); // ç¡®ä¿å½“å‰è¿›åº¦ä¸è¶…è¿‡æ€»æ•°
                    task.estimatedTime = estimatedTime;
                } else {
                    // æ›´æ–°é˜¶æ®µæµç¨‹ç±»ä»»åŠ¡
                    const stepsText = document.getElementById('editStageStepsInput').value.trim();
                    if (!stepsText) {
                        alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ­¥éª¤');
                        return;
                    }
                    
                    // æ”¯æŒé€—å·æˆ–æ¢è¡Œç¬¦åˆ†éš”
                    const stepNames = stepsText.split(/[,\n]/).filter(s => s.trim()).map(s => s.trim());
                    if (stepNames.length === 0) {
                        alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ­¥éª¤');
                        return;
                    }
                    
                    // ä¿ç•™å·²å®Œæˆæ­¥éª¤çš„çŠ¶æ€ï¼ˆå¦‚æœæ–°æ­¥éª¤åç§°ä¸æ—§æ­¥éª¤åç§°åŒ¹é…ï¼‰
                    const oldSteps = task.steps || [];
                    const oldStepsMap = {};
                    oldSteps.forEach(step => {
                        oldStepsMap[step.name] = step.completed;
                    });
                    
                    // åˆ›å»ºæ–°æ­¥éª¤ï¼Œä¿ç•™åŒ¹é…æ­¥éª¤çš„å®ŒæˆçŠ¶æ€
                    const newSteps = stepNames.map(stepName => ({
                        name: stepName,
                        completed: oldStepsMap[stepName] || false
                    }));
                    
                    const estimatedTime = parseInt(document.getElementById('editStageEstimatedTime').value) || null;
                    
                    task.steps = newSteps;
                    task.estimatedTime = estimatedTime;
                }
                
                Storage.setTasks(tasks);
                renderTasks();
                closeModal();
            };
        }

        // æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        function showAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            modal.classList.remove('hidden');
            
            // é‡ç½®è¡¨å•
            document.getElementById('modalTaskName').value = '';
            document.querySelector('input[name="taskType"][value="numeric"]').checked = true;
            document.getElementById('modalTotal').value = '20';
            document.getElementById('modalCurrent').value = '0';
            document.getElementById('stageStepsInput').value = '';
            document.getElementById('stageStepsContainer').classList.add('hidden');
            document.getElementById('numericInputsContainer').classList.remove('hidden');
            
            // ç›‘å¬ä»»åŠ¡ç±»å‹å˜åŒ–
            document.querySelectorAll('input[name="taskType"]').forEach(radio => {
                radio.onchange = function() {
                    if (this.value === 'stage') {
                        document.getElementById('stageStepsContainer').classList.remove('hidden');
                        document.getElementById('numericInputsContainer').classList.add('hidden');
                        
                        // åˆå§‹åŒ–é¢„è§ˆ
                        const stepsInput = document.getElementById('stageStepsInput');
                        updateStagePreviewForAdd(stepsInput.value);
                        
                        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
                        stepsInput.addEventListener('input', function() {
                            updateStagePreviewForAdd(this.value);
                        });
                    } else {
                        document.getElementById('stageStepsContainer').classList.add('hidden');
                        document.getElementById('numericInputsContainer').classList.remove('hidden');
                    }
                };
            });
            
            // å…³é—­æ¨¡æ€æ¡†çš„å‡½æ•°
            const closeModal = () => {
                modal.classList.add('hidden');
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            };
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelAddTaskBtn').onclick = closeModal;
            
            // ç¡®è®¤æŒ‰é’®
            document.getElementById('confirmAddTaskBtn').onclick = () => {
                const name = document.getElementById('modalTaskName').value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                    return;
                }
                
                const taskType = document.querySelector('input[name="taskType"]:checked').value;
                const tasks = Storage.getTasks();
                
                if (taskType === 'numeric') {
                    // æ•°å­—ç»Ÿè®¡ç±»
                    const total = parseInt(document.getElementById('modalTotal').value) || 20;
                    const current = parseInt(document.getElementById('modalCurrent').value) || 0;
                    const estimatedTime = parseInt(document.getElementById('modalEstimatedTime').value) || null;
                    
                    tasks.push({
                        type: 'numeric',
                        name: name,
                        current: Math.max(0, Math.min(current, total)),
                        total: Math.max(1, total),
                        estimatedTime: estimatedTime,
                        today: false
                    });
                } else {
                    // é˜¶æ®µæµç¨‹ç±»
                    const stepsText = document.getElementById('stageStepsInput').value.trim();
                    if (!stepsText) {
                        alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ­¥éª¤');
                        return;
                    }
                    
                    const stepNames = stepsText.split(/[,\n]/).filter(s => s.trim()).map(s => s.trim());
                    if (stepNames.length === 0) {
                        alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ­¥éª¤');
                        return;
                    }
                    
                    const steps = stepNames.map(stepName => ({
                        name: stepName,
                        completed: false
                    }));
                    const estimatedTime = parseInt(document.getElementById('modalStageEstimatedTime').value) || null;
                    
                    tasks.push({
                        type: 'stage',
                        name: name,
                        steps: steps,
                        estimatedTime: estimatedTime,
                        today: false
                    });
                }
                
                Storage.setTasks(tasks);
                renderTasks();
                closeModal();
            };
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
